import{r as Ne,b as ye,a as we,c as u,u as U,d as H,N as _e,e as Ce,R as Ee,f as ke}from"./vendor-sGmgHiac.js";import{c as Re}from"./supabase-CT8fK44Y.js";(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))t(o);new MutationObserver(o=>{for(const l of o)if(l.type==="childList")for(const h of l.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&t(h)}).observe(document,{childList:!0,subtree:!0});function a(o){const l={};return o.integrity&&(l.integrity=o.integrity),o.referrerPolicy&&(l.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?l.credentials="include":o.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function t(o){if(o.ep)return;o.ep=!0;const l=a(o);fetch(o.href,l)}})();var K={exports:{}},F={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Y;function Se(){if(Y)return F;Y=1;var s=Ne(),r=Symbol.for("react.element"),a=Symbol.for("react.fragment"),t=Object.prototype.hasOwnProperty,o=s.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,l={key:!0,ref:!0,__self:!0,__source:!0};function h(n,c,x){var v,_={},w=null,p=null;x!==void 0&&(w=""+x),c.key!==void 0&&(w=""+c.key),c.ref!==void 0&&(p=c.ref);for(v in c)t.call(c,v)&&!l.hasOwnProperty(v)&&(_[v]=c[v]);if(n&&n.defaultProps)for(v in c=n.defaultProps,c)_[v]===void 0&&(_[v]=c[v]);return{$$typeof:r,type:n,key:w,ref:p,props:_,_owner:o.current}}return F.Fragment=a,F.jsx=h,F.jsxs=h,F}var ee;function Ie(){return ee||(ee=1,K.exports=Se()),K.exports}var e=Ie(),W={},se;function Me(){if(se)return W;se=1;var s=ye();return W.createRoot=s.createRoot,W.hydrateRoot=s.hydrateRoot,W}var $e=Me();const De=we($e),ie="https://krisjvemfpnkmduebqdr.supabase.co",ce="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtyaXNqdmVtZnBua21kdWVicWRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc4NTQ5MTMsImV4cCI6MjA2MzQzMDkxM30.jktcXSfSQfcfXUPTDuvu75GuUscMhpsYnvhfloRUf4I",j=Re(ie,ce,{auth:{autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0},global:{headers:{"x-client-info":"copiloto-app"}}});j.auth.onAuthStateChange((s,r)=>{console.log("🔐 Auth state changed:",s,{userId:r?.user?.id,email:r?.user?.email,hasToken:!!r?.access_token})});async function qe(){try{console.log("🔗 Testando conexão com Supabase..."),console.log("📍 URL:",ie),console.log("🔑 Anon Key (primeiros 20 chars):",ce?.substring(0,20)+"...");const{data:s,error:r}=await j.from("profiles").select("count").limit(1);console.log("📊 Teste de conexão com profiles:",{hasData:!!s,error:r?.message,errorCode:r?.code}),r&&console.error("❌ Erro ao conectar com profiles:",{message:r.message,code:r.code,hint:r.hint,details:r.details});const{data:{user:a},error:t}=await j.auth.getUser();return console.log("👤 Status de autenticação:",{isAuthenticated:!!a,userEmail:a?.email,authError:t?.message}),r||console.log("✅ Conexão com database bem-sucedida!"),!r}catch(s){return console.error("💥 Erro crítico na conexão:",{error:s,message:s instanceof Error?s.message:"Erro desconhecido"}),!1}}async function Ae(s,r){try{console.log("🔐 Tentando login com:",{email:s,password:r.substring(0,3)+"***",emailLength:s.length,passwordLength:r.length});const{data:a,error:t}=await j.auth.signInWithPassword({email:s.trim(),password:r.trim()});if(console.log("📊 Resposta da autenticação:",{hasAuthData:!!a,hasUser:!!a?.user,authError:t?.message,authErrorCode:t?.status||t?.code}),t||!a.user)return console.error("❌ Erro de autenticação detalhado:",{error:t,message:t?.message,status:t?.status,code:t?.code}),{user:null,error:t?.message||"Credenciais inválidas"};console.log("✅ Autenticação bem-sucedida, buscando perfil...",{userId:a.user.id,userEmail:a.user.email});const{data:o,error:l}=await j.from("profiles").select("*").eq("id",a.user.id).single();if(console.log("📋 Resposta do perfil:",{hasProfile:!!o,profileError:l?.message,profileData:o?{id:o.id,nome_completo:o.nome_completo,apelido:o.apelido,cargo:o.cargo}:null}),l)return console.error("❌ Erro ao buscar perfil detalhado:",{error:l,message:l.message,code:l.code,hint:l.hint}),{user:null,error:`Erro ao carregar dados do usuário: ${l.message}`};if(!o)return console.error("❌ Perfil não encontrado para o usuário"),{user:null,error:"Perfil do usuário não encontrado"};const h={id:a.user.id,email:a.user.email,nome:o.nome_completo,apelido:o.apelido,cargo:o.cargo,cod_vendedor:o.cod_vendedor,profile:o};return console.log("✅ Login bem-sucedido:",{email:h.email,nome:h.nome,apelido:h.apelido,cargo:h.cargo}),{user:h,error:null}}catch(a){return console.error("💥 Erro de conexão detalhado:",{error:a,message:a instanceof Error?a.message:"Erro desconhecido",stack:a instanceof Error?a.stack:void 0}),{user:null,error:"Erro na conexão"}}}async function Te(){try{const{error:s}=await j.auth.signOut();return s?(console.error("❌ Erro no logout:",s),{error:s.message}):{error:null}}catch(s){return console.error("💥 Erro no logout:",s),{error:"Erro na conexão"}}}async function Ue(){try{const{data:{user:s},error:r}=await j.auth.getUser();if(r||!s)return{user:null,error:r?.message||null};const{data:a,error:t}=await j.from("profiles").select("*").eq("id",s.id).single();return t?(console.error("❌ Erro ao buscar perfil:",t),{user:null,error:"Erro ao carregar dados do usuário"}):{user:{id:s.id,email:s.email,nome:a.nome_completo,apelido:a.apelido,cargo:a.cargo,cod_vendedor:a.cod_vendedor,profile:a},error:null}}catch(s){return console.error("💥 Erro ao verificar usuário:",s),{user:null,error:"Erro na conexão"}}}async function Le(){try{const{data:s,error:r}=await j.from("vw_clientes_completo").select("*");return r?(console.error("Erro ao buscar clientes:",r),{data:[],error:r.message}):{data:s,error:null}}catch(s){return console.error("Erro na conexão ao buscar clientes:",s),{data:[],error:"Erro na conexão"}}}async function Pe(){try{const{data:s,error:r}=await j.from("rotas").select("*");return r?(console.error("Erro ao buscar rotas:",r),{data:[],error:r.message}):{data:s,error:null}}catch(s){return console.error("Erro na conexão ao buscar rotas:",s),{data:[],error:"Erro na conexão"}}}async function Ve(){try{const{data:s,error:r}=await j.from("cidades").select("*");return r?(console.error("Erro ao buscar cidades:",r),{data:[],error:r.message}):{data:s,error:null}}catch(s){return console.error("Erro na conexão ao buscar cidades:",s),{data:[],error:"Erro na conexão"}}}async function Oe(){try{const{data:s,error:r}=await j.from("compras_produto_cliente").select("*");return r?(console.error("Erro ao buscar vendas:",r),{data:[],error:r.message}):{data:s,error:null}}catch(s){return console.error("Erro na conexão ao buscar vendas:",s),{data:[],error:"Erro na conexão"}}}async function Be(s){try{const{data:r,error:a}=await j.from("profiles").select("*").eq("id",s).single();return a?(console.error("Erro ao buscar perfil:",a),{data:null,error:a.message}):{data:r,error:null}}catch(r){return console.error("Erro na conexão ao buscar perfil:",r),{data:null,error:"Erro na conexão"}}}const de=u.createContext(void 0),q=()=>{const s=u.useContext(de);if(s===void 0)throw new Error("useAuth must be used within an AuthProvider");return s},Fe=({children:s})=>{const[r,a]=u.useState(null),[t,o]=u.useState(!0);u.useEffect(()=>{(async()=>{const{user:x,error:v}=await Ue();x&&!v&&a(x),o(!1)})()},[]);const n={user:r,loading:t,login:async(c,x)=>{o(!0);try{const{user:v,error:_}=await Ae(c,x);return _||!v?(o(!1),{success:!1,error:_||"Erro desconhecido"}):(a(v),o(!1),{success:!0})}catch{return o(!1),{success:!1,error:"Erro na conexão"}}},logout:async()=>{o(!0);try{r?.profile?.cod_vendedor&&localStorage.removeItem(`vendedor_${r.profile.cod_vendedor}`),await Te(),a(null)}catch(c){console.error("Erro no logout:",c)}finally{o(!1)}}};return e.jsx(de.Provider,{value:n,children:s})},me=u.createContext(void 0),V=()=>{const s=u.useContext(me);if(s===void 0)throw new Error("useUserData must be used within a UserDataProvider");return s},A=({children:s})=>{const{user:r}=q(),[a,t]=u.useState({profile:null,clientes:[],rotas:[],cidades:[],vendas:[]}),[o,l]=u.useState(!1),[h,n]=u.useState(null),c=async p=>{l(!0),n(null);const N={profile:null,clientes:[],rotas:[],cidades:[],vendas:[]};try{const{data:m,error:E}=await Be(p);if(E)throw new Error(`Erro ao carregar perfil: ${E}`);N.profile=m;const b=[{key:"clientes",fn:Le},{key:"rotas",fn:Pe},{key:"cidades",fn:Ve},{key:"vendas",fn:Oe}];for(const{key:C,fn:k}of b)try{const{data:g,error:d}=await k();d?(console.warn(`Erro ao carregar ${C}:`,d),N[C]=[]):N[C]=g||[]}catch(g){console.warn(`Erro ao carregar ${C}:`,g),N[C]=[]}const I=`userData_${p}`;localStorage.setItem(I,JSON.stringify({...N,loadedAt:new Date().toISOString()})),t(N)}catch(m){console.error("Erro ao carregar dados:",m),n(m instanceof Error?m.message:"Erro desconhecido")}finally{l(!1)}};u.useEffect(()=>{if(r?.id){const p=`userData_${r.id}`,N=localStorage.getItem(p);if(N)try{const m=JSON.parse(N);t(m)}catch(m){console.warn("Erro ao carregar cache:",m),c(r.id)}else c(r.id)}else t({profile:null,clientes:[],rotas:[],cidades:[],vendas:[]}),n(null)},[r?.id]);const x=p=>Array.isArray(a[p])?a[p].length>0:a[p]!==null,v=()=>{r?.id&&c(r.id)},_=()=>{if(r?.id){const p=`userData_${r.id}`;localStorage.removeItem(p)}t({profile:null,clientes:[],rotas:[],cidades:[],vendas:[]}),n(null)},w={profile:a.profile,clientes:a.clientes,rotas:a.rotas,cidades:a.cidades,vendas:a.vendas,loading:o,error:h,hasData:x,refresh:v,clear:_};return e.jsx(me.Provider,{value:w,children:s})};/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ze=s=>s.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase(),We=s=>s.replace(/^([A-Z])|[\s-_]+(\w)/g,(r,a,t)=>t?t.toUpperCase():a.toLowerCase()),re=s=>{const r=We(s);return r.charAt(0).toUpperCase()+r.slice(1)},ue=(...s)=>s.filter((r,a,t)=>!!r&&r.trim()!==""&&t.indexOf(r)===a).join(" ").trim(),Je=s=>{for(const r in s)if(r.startsWith("aria-")||r==="role"||r==="title")return!0};/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */var Xe={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ze=u.forwardRef(({color:s="currentColor",size:r=24,strokeWidth:a=2,absoluteStrokeWidth:t,className:o="",children:l,iconNode:h,...n},c)=>u.createElement("svg",{ref:c,...Xe,width:r,height:r,stroke:s,strokeWidth:t?Number(a)*24/Number(r):a,className:ue("lucide",o),...!l&&!Je(n)&&{"aria-hidden":"true"},...n},[...h.map(([x,v])=>u.createElement(x,v)),...Array.isArray(l)?l:[l]]));/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const R=(s,r)=>{const a=u.forwardRef(({className:t,...o},l)=>u.createElement(Ze,{ref:l,iconNode:r,className:ue(`lucide-${ze(re(s))}`,`lucide-${s}`,t),...o}));return a.displayName=re(s),a};/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ge=[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]],z=R("arrow-left",Ge);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Qe=[["rect",{width:"16",height:"20",x:"4",y:"2",rx:"2",ry:"2",key:"76otgf"}],["path",{d:"M9 22v-4h6v4",key:"r93iot"}],["path",{d:"M8 6h.01",key:"1dz90k"}],["path",{d:"M16 6h.01",key:"1x0f13"}],["path",{d:"M12 6h.01",key:"1vi96p"}],["path",{d:"M12 10h.01",key:"1nrarc"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M16 10h.01",key:"1m94wz"}],["path",{d:"M16 14h.01",key:"1gbofw"}],["path",{d:"M8 10h.01",key:"19clt8"}],["path",{d:"M8 14h.01",key:"6423bh"}]],xe=R("building",Qe);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ke=[["path",{d:"m6 9 6 6 6-6",key:"qrunsl"}]],J=R("chevron-down",Ke);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const He=[["path",{d:"m18 15-6-6-6 6",key:"153udz"}]],X=R("chevron-up",He);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ye=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]],he=R("circle-alert",Ye);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const es=[["path",{d:"M10.733 5.076a10.744 10.744 0 0 1 11.205 6.575 1 1 0 0 1 0 .696 10.747 10.747 0 0 1-1.444 2.49",key:"ct8e1f"}],["path",{d:"M14.084 14.158a3 3 0 0 1-4.242-4.242",key:"151rxh"}],["path",{d:"M17.479 17.499a10.75 10.75 0 0 1-15.417-5.151 1 1 0 0 1 0-.696 10.75 10.75 0 0 1 4.446-5.143",key:"13bj9a"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]],ss=R("eye-off",es);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const rs=[["path",{d:"M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0",key:"1nclc0"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]],as=R("eye",rs);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ts=[["path",{d:"M10 20a1 1 0 0 0 .553.895l2 1A1 1 0 0 0 14 21v-7a2 2 0 0 1 .517-1.341L21.74 4.67A1 1 0 0 0 21 3H3a1 1 0 0 0-.742 1.67l7.225 7.989A2 2 0 0 1 10 14z",key:"sc7q7i"}]],pe=R("funnel",ts);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const os=[["path",{d:"m10 17 5-5-5-5",key:"1bsop3"}],["path",{d:"M15 12H3",key:"6jk70r"}],["path",{d:"M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4",key:"u53s6r"}]],ns=R("log-in",os);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ls=[["path",{d:"m16 17 5-5-5-5",key:"1bji2h"}],["path",{d:"M21 12H9",key:"dn1m92"}],["path",{d:"M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4",key:"1uf3rs"}]],O=R("log-out",ls);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const is=[["path",{d:"M20 10c0 4.993-5.539 10.193-7.399 11.799a1 1 0 0 1-1.202 0C9.539 20.193 4 14.993 4 10a8 8 0 0 1 16 0",key:"1r0f0z"}],["circle",{cx:"12",cy:"10",r:"3",key:"ilqhr7"}]],ge=R("map-pin",is);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const cs=[["path",{d:"M14.106 5.553a2 2 0 0 0 1.788 0l3.659-1.83A1 1 0 0 1 21 4.619v12.764a1 1 0 0 1-.553.894l-4.553 2.277a2 2 0 0 1-1.788 0l-4.212-2.106a2 2 0 0 0-1.788 0l-3.659 1.83A1 1 0 0 1 3 19.381V6.618a1 1 0 0 1 .553-.894l4.553-2.277a2 2 0 0 1 1.788 0z",key:"169xi5"}],["path",{d:"M15 5.764v15",key:"1pn4in"}],["path",{d:"M9 3.236v15",key:"1uimfh"}]],ds=R("map",cs);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ms=[["path",{d:"M7.9 20A9 9 0 1 0 4 16.1L2 22Z",key:"vv11sd"}]],fe=R("message-circle",ms);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const us=[["path",{d:"M12 19v3",key:"npa21l"}],["path",{d:"M19 10v2a7 7 0 0 1-14 0v-2",key:"1vc78b"}],["rect",{x:"9",y:"2",width:"6",height:"13",rx:"3",key:"s6n7sd"}]],xs=R("mic",us);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const hs=[["path",{d:"M13.832 16.568a1 1 0 0 0 1.213-.303l.355-.465A2 2 0 0 1 17 15h3a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2A18 18 0 0 1 2 4a2 2 0 0 1 2-2h3a2 2 0 0 1 2 2v3a2 2 0 0 1-.8 1.6l-.468.351a1 1 0 0 0-.292 1.233 14 14 0 0 0 6.392 6.384",key:"9njp5v"}]],ve=R("phone",hs);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ps=[["path",{d:"m21 21-4.34-4.34",key:"14j7rj"}],["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}]],Q=R("search",ps);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const gs=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["circle",{cx:"12",cy:"12",r:"6",key:"1vlfrh"}],["circle",{cx:"12",cy:"12",r:"2",key:"1c9p78"}]],fs=R("target",gs);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const vs=[["path",{d:"M16 7h6v6",key:"box55l"}],["path",{d:"m22 7-8.5 8.5-5-5L2 17",key:"1t1m79"}]],bs=R("trending-up",vs);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const js=[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]],G=R("triangle-alert",js);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ns=[["path",{d:"M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2",key:"975kel"}],["circle",{cx:"12",cy:"7",r:"4",key:"17ys0d"}]],B=R("user",Ns),ys="/assets/Logo%20Focco%20Brasil-DXXX8y_m.png",ws=()=>{const[s,r]=u.useState(""),[a,t]=u.useState(""),[o,l]=u.useState(!1),[h,n]=u.useState(""),[c,x]=u.useState(!1),v=U(),{login:_,user:w}=q();u.useEffect(()=>{w&&v("/dashboard")},[w,v]),u.useEffect(()=>{qe()},[]);const p=async N=>{N.preventDefault(),n(""),x(!0),console.log("🔑 Iniciando processo de login..."),console.log("👤 Email:",s),console.log("🔒 Senha tem",a.length,"caracteres");try{const m=await _(s,a);console.log("📋 Resultado do login:",m),m.success?(console.log("✅ Login bem-sucedido, redirecionando..."),v("/dashboard")):(console.error("❌ Falha no login:",m.error),n(m.error||"Erro desconhecido"))}catch(m){console.error("💥 Erro crítico:",m),n("Erro na conexão com o servidor")}finally{x(!1)}};return e.jsx("div",{className:"min-h-screen gradient-bg flex items-center justify-center px-4",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl p-8 w-full max-w-md",children:[e.jsxs("div",{className:"text-center mb-8",children:[e.jsx("img",{src:ys,alt:"Focco Brasil",className:"w-15 h-10 mb-4 mx-auto"}),e.jsx("h1",{className:"text-2xl font-semibold text-primary mb-2",children:"Bem-vindo"}),e.jsx("p",{className:"text-gray-600",children:"Acesse sua plataforma de vendas"})]}),e.jsxs("form",{onSubmit:p,className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"E-mail"}),e.jsx("input",{type:"email",value:s,onChange:N=>r(N.target.value),placeholder:"seu.email@empresa.com",className:"w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent",required:!0,disabled:c})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Senha"}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:o?"text":"password",value:a,onChange:N=>t(N.target.value),placeholder:"••••••••",className:"w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent pr-12",required:!0,disabled:c}),e.jsx("button",{type:"button",onClick:()=>l(!o),className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700",children:o?e.jsx(ss,{size:20}):e.jsx(as,{size:20})})]})]}),h&&e.jsxs("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4 flex items-center gap-2",children:[e.jsx(he,{className:"h-5 w-5 text-red-600"}),e.jsx("span",{className:"text-red-700 text-sm",children:h})]}),e.jsx("button",{type:"submit",disabled:c,className:"w-full bg-primary text-white py-3 rounded-lg font-medium hover:bg-primary/90 transition-colors flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed",children:c?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-white"}),"Entrando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ns,{size:20}),"Entrar no Sistema"]})})]}),e.jsx("div",{className:"text-center mt-8 text-sm text-gray-500",children:e.jsx("p",{children:"Plataforma de Gestão Comercial"})})]})})};async function _s(){try{console.log("📊 Iniciando busca de métricas do dashboard...");const{data:{user:s},error:r}=await j.auth.getUser();if(r||!s)throw new Error("Usuário não autenticado");console.log("🔍 ANTES da query - user.id:",s.id);const{data:a,error:t}=await j.from("vw_dashboard_metricas").select("*").eq("vendedor_id",s.id).single();if(console.log("🔍 DEPOIS da query - error:",t),console.log("🔍 DEPOIS da query - data recebido:",a),console.log("🔍 VALOR ESPECÍFICO vendas_mes:",a?.vendas_mes,typeof a?.vendas_mes),t)throw t;if(!a)throw new Error("Nenhuma métrica encontrada para o vendedor");return{vendas_mes:Number(a.vendas_mes||0),oticas_positivadas:Number(a.oticas_positivadas||0),meta_mes:Number(a.meta_mes||0),percentual_meta:Number(a.percentual_atingimento||0)}}catch(s){throw console.error("💥 Erro ao buscar métricas:",s),s}}async function Cs(){try{console.log("🏙️ Iniciando busca de top 10 cidades...");const{data:s,error:r}=await j.from("vw_top10_cidades").select("*").eq("vendedor_uuid",(await j.auth.getUser()).data.user?.id).order("valor_vendas",{ascending:!1}).limit(10);if(console.log("🏙️ Resposta da view vw_top10_cidades:",{dadosCount:s?.length||0,primeirosDados:s?.slice(0,3),error:r,userId:(await j.auth.getUser()).data.user?.id}),r)throw console.error("❌ Erro ao buscar top 10 cidades:",r),r;if(!s||s.length===0)return console.log("⚠️ Nenhuma cidade encontrada"),[];const a=s.map((t,o)=>({cidade:t.cidade,qtd_oticas:Number(t.qtd_oticas||0),valor_vendas:Number(t.valor_vendas||0),posicao:o+1}));return console.log("✅ Top 10 cidades processadas:",a.length),a}catch(s){throw console.error("💥 Erro ao buscar top 10 cidades:",s),s}}async function Es(){try{console.log("🛣️ Iniciando busca de ranking de rotas...");const{data:s,error:r}=await j.from("vw_ranking_rotas").select("*").eq("vendedor_uuid",(await j.auth.getUser()).data.user?.id).order("percentual_meta",{ascending:!1});if(console.log("🛣️ Resposta da view vw_ranking_rotas:",{dadosCount:s?.length||0,primeirosDados:s?.slice(0,3),error:r,userId:(await j.auth.getUser()).data.user?.id}),r)throw console.error("❌ Erro ao buscar ranking de rotas:",r),r;if(!s||s.length===0)return console.log("⚠️ Nenhuma rota encontrada no ranking"),[];const a=s.map(t=>({rota:t.rota,nome_rota:t.nome_rota||t.rota,qtd_oticas:t.qtd_oticas||0,vendido_2025:t.vendido_2025||0,meta_2025:t.meta_2025||0,percentual_meta:t.percentual_meta||0,ranking:t.ranking||0,saldo_restante:(t.meta_2025||0)-(t.vendido_2025||0)}));return console.log("✅ Ranking de rotas processado:",a.length),a}catch(s){throw console.error("💥 Erro ao buscar ranking de rotas:",s),s}}async function ks(){try{console.log("🏢 Iniciando busca de top 20 clientes...");const{data:{user:s},error:r}=await j.auth.getUser();if(r||!s)throw new Error("Usuário não autenticado");const{data:a,error:t}=await j.from("vw_top20_clientes").select("*").eq("vendedor_uuid",s.id).order("valor_vendas_2025",{ascending:!1}).limit(20);if(console.log("🏢 Resposta da view vw_top20_clientes:",{dadosCount:a?.length||0,primeirosDados:a?.slice(0,3),error:t,userId:s.id}),t)throw console.error("❌ Erro ao buscar top 20 clientes:",t),t;if(!a||a.length===0)return console.log("⚠️ Nenhum cliente encontrado"),[];const o=a.map(l=>({nome:l.nome_fantasia,rota:l.rota||"Sem rota",meta:Number(l.meta_2025||0),vendido:Number(l.valor_vendas_2025||0),percentual:Number(l.percentual_atingimento||0),codigo_cliente:l.codigo_cliente}));return console.log("✅ Top 20 clientes processados:",o.length),o}catch(s){throw console.error("💥 Erro ao buscar top 20 clientes:",s),s}}function Rs(s){const r=[];return!s.metricas.vendas_mes&&s.metricas.vendas_mes!==0&&r.push("Métricas: vendas_mes é undefined"),!s.metricas.oticas_positivadas&&s.metricas.oticas_positivadas!==0&&r.push("Métricas: oticas_positivadas é undefined"),s.top10Cidades.length===0?r.push("Top 10 cidades: lista vazia"):s.top10Cidades.forEach((a,t)=>{a.cidade||r.push(`Cidade ${t+1}: nome indefinido`),a.valor_vendas<0&&r.push(`Cidade ${a.cidade}: valor_vendas negativo`)}),s.rankingRotas.length===0?r.push("Ranking rotas: lista vazia"):s.rankingRotas.forEach((a,t)=>{a.rota||r.push(`Rota ${t+1}: nome indefinido`),a.meta_2025<0&&r.push(`Rota ${a.rota}: meta_2025 negativa`),(a.percentual_meta<0||a.percentual_meta>999)&&r.push(`Rota ${a.rota}: percentual_meta inválido (${a.percentual_meta}%)`)}),s.top20Clientes.length===0?r.push("Top 20 clientes: lista vazia"):s.top20Clientes.forEach((a,t)=>{a.nome||r.push(`Cliente ${t+1}: nome indefinido`),a.meta<0&&r.push(`Cliente ${a.nome}: meta negativa`),a.vendido<0&&r.push(`Cliente ${a.nome}: vendido negativo`)}),{valido:r.length===0,problemas:r}}async function Ss(){try{console.log("🔍 Carregando dados completos do dashboard...");const[s,r,a,t]=await Promise.all([_s(),Cs(),Es(),ks()]),o={metricas:s,top10Cidades:r,rankingRotas:a,top20Clientes:t},l=Rs(o);return l.valido||console.warn("⚠️ Problemas de consistência encontrados:",l.problemas),console.log("✅ Dados do dashboard carregados:",{metricas:s,cidadesCount:r.length,rotasCount:a.length,clientesCount:t.length,validacao:l.valido?"Válido":"Com problemas"}),o}catch(s){throw console.error("💥 Erro ao carregar dashboard completo:",s),s}}function P(s){return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL",minimumFractionDigits:0,maximumFractionDigits:0}).format(s)}function ae(s){return s>=1e6?`${(s/1e6).toFixed(1)}M`:s>=1e3?`${(s/1e3).toFixed(0)}k`:s.toString()}async function be(){try{console.log("👨‍💼 Iniciando busca de ranking do vendedor...");const{data:{user:s},error:r}=await j.auth.getUser();if(r||!s)throw new Error("Usuário não autenticado");console.log("👨‍💼 Buscando ranking para vendedor:",{userId:s.id,email:s.email});const{data:a,error:t}=await j.from("vw_ranking_vendedores").select("*").eq("vendedor_uuid",s.id).single();if(console.log("👨‍💼 Resposta da view vw_ranking_vendedores:",{data:a,error:t,userId:s.id}),t){if(t.code==="PGRST116")return console.log("⚠️ Nenhum ranking encontrado para o vendedor atual"),null;throw console.error("❌ Erro ao buscar ranking do vendedor:",t),t}const o={vendedor_uuid:a.vendedor_uuid,cod_vendedor:a.cod_vendedor,nome_completo:a.nome_completo,apelido:a.apelido,total_clientes:Number(a.total_clientes||0),clientes_sem_vendas_90d:Number(a["+90d"]||0),vendas_ano:Number(a.vendas_ano||0),meta_ano:Number(a.meta_ano||0),percentual_meta:Number(a.percentual_meta||0),total_inadimplencia:Number(a.total_inadimplencia||0)};return console.log("✅ Ranking do vendedor processado:",o),o}catch(s){throw console.error("💥 Erro ao buscar ranking do vendedor:",s),s}}function je(s){return s?.cargo==="diretor"||s?.cargo==="gestor"}function $(s,r){const a=je(s);switch(r){case"clientes":return{title:"Nenhum cliente encontrado",subtitle:a?"Não há clientes cadastrados no sistema.":"Você não possui clientes atribuídos no momento."};case"rotas":return{title:"Nenhuma rota encontrada",subtitle:a?"Não há rotas cadastradas no sistema.":"Você não possui rotas ativas no momento."};case"cidades":return{title:"Nenhuma cidade encontrada",subtitle:a?"Não há cidades cadastradas no sistema.":"Você não possui cidades em suas rotas."};case"dashboard":return{title:"Sem dados disponíveis",subtitle:a?"Não há dados de vendas ou métricas no sistema.":"Você ainda não possui dados de vendas ou métricas."};default:return{title:"Nenhum dado encontrado",subtitle:"Não há informações disponíveis no momento."}}}const Is=()=>{const s=U(),{user:r,logout:a}=q();V();const[t,o]=u.useState(null),[l,h]=u.useState(null),[n,c]=u.useState([]),[x,v]=u.useState(null),[_,w]=u.useState(null),[p,N]=u.useState(!0),[m,E]=u.useState(null),[b,I]=u.useState(!1);u.useEffect(()=>{async function i(){if(!(!r?.id||b))try{I(!0),N(!0),E(null),console.log("🔍 Carregando dados do dashboard para usuário:",{userId:r?.id,email:r?.email,cargo:r?.cargo});const f=await Ss();let y=null;try{y=await be()}catch(D){console.warn("⚠️ Não foi possível carregar dados do vendedor:",D)}const S=f.top20Clientes;console.log("✅ Dados completos carregados:",{dashboard:{metricas:f.metricas,cidadesCount:f.top10Cidades.length,rotasCount:f.rankingRotas.length,clientesCount:f.top20Clientes.length},vendedorRanking:y}),f.top10Cidades.length===0&&f.rankingRotas.length===0&&S.length===0&&console.warn("⚠️ Nenhum dado encontrado - possível problema com RLS"),v(f),c(S),w(y)}catch(f){console.error("💥 Erro ao carregar dados do dashboard:",{error:f,message:f instanceof Error?f.message:"Erro desconhecido",stack:f instanceof Error?f.stack:void 0,user:{id:r?.id,email:r?.email,cargo:r?.cargo}}),E(f instanceof Error?f.message:"Erro desconhecido"),v(null),c([]),w(null)}finally{N(!1),I(!1)}}i()},[r?.id]);const C=u.useMemo(()=>{let i=[...n];return t?i.sort((y,S)=>t==="asc"?y.rota.localeCompare(S.rota):S.rota.localeCompare(y.rota)):l&&i.sort((y,S)=>l==="asc"?y.percentual-S.percentual:S.percentual-y.percentual),i.map(y=>{const S=n.sort((D,L)=>L.percentual-D.percentual).findIndex(D=>D.nome===y.nome)+1;return{...y,posicao:S}})},[t,l,n]),k=()=>{h(null),o(t===null?"asc":t==="asc"?"desc":null)},g=()=>{o(null),h(l===null?"desc":l==="desc"?"asc":null)},d=()=>{a(),s("/")};return e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx("header",{className:"bg-primary text-white shadow-lg",children:e.jsx("div",{className:"max-w-7xl mx-auto px-3 sm:px-6 lg:px-8",children:e.jsxs("div",{className:"flex items-center justify-between h-14 relative",children:[e.jsx("div",{className:"flex items-center"}),e.jsx("div",{className:"flex items-center absolute left-1/2 transform -translate-x-1/2",children:e.jsx("h1",{className:"text-lg font-bold",children:"Copiloto"})}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("div",{className:"flex items-center space-x-1.5",children:[e.jsx(B,{className:"h-4 w-4"}),e.jsx("span",{className:"text-sm",children:r?.apelido||r?.nome||r?.email||"Usuário"})]}),e.jsx("button",{onClick:d,className:"p-1.5 hover:bg-white/10 rounded-full transition-colors",children:e.jsx(O,{className:"h-4 w-4"})})]})]})})}),e.jsxs("main",{className:"max-w-7xl mx-auto px-3 sm:px-6 lg:px-8 py-4 lg:py-8",children:[e.jsxs("div",{className:"flex items-center justify-between mb-8",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900",children:"Dashboard Pessoal"}),e.jsxs("p",{className:"text-gray-600",children:["Bem-vindo, ",r?.apelido||r?.nome||r?.email||"Usuário","! Aqui estão suas métricas"]})]}),e.jsxs("div",{className:"flex items-center space-x-2 sm:space-x-3",children:[e.jsx("button",{onClick:()=>s("/inadimplentes"),className:"bg-red-600 text-white p-2 sm:px-4 sm:py-2 rounded-lg font-medium hover:bg-red-700 transition-colors flex items-center justify-center",children:e.jsx(G,{className:"h-4 w-4 sm:h-5 sm:w-5"})}),e.jsx("button",{onClick:()=>s("/rotas"),className:"bg-primary text-white p-2 sm:px-4 sm:py-2 rounded-lg font-medium hover:bg-primary/90 transition-colors flex items-center justify-center",children:e.jsx(ds,{className:"h-4 w-4 sm:h-5 sm:w-5"})})]})]}),p?e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 mb-8",children:[...Array(4)].map((i,f)=>e.jsx("div",{className:"bg-white rounded-lg shadow-md border border-gray-200 p-4",children:e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"h-3 bg-gray-200 rounded mb-2"}),e.jsx("div",{className:"h-6 bg-gray-200 rounded mb-1"}),e.jsx("div",{className:"h-2 bg-gray-200 rounded"})]})},f))}):m?e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4 mb-8",children:e.jsxs("p",{className:"text-red-600 text-sm",children:["Erro ao carregar métricas: ",m]})}):e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 mb-8",children:[e.jsxs("div",{className:"bg-white rounded-lg shadow-md border border-gray-200 p-4 relative",children:[e.jsx("div",{className:"absolute top-3 right-3",children:e.jsx("div",{className:"bg-blue-50 p-2 rounded-full",children:e.jsx(bs,{className:"h-5 w-5 text-blue-600"})})}),e.jsxs("div",{className:"pr-12",children:[e.jsx("p",{className:"text-xs font-medium text-gray-600",children:"Vendas do Mês"}),e.jsx("p",{className:"text-xl font-bold text-gray-900 mt-1",children:x?.metricas?P(x.metricas.vendas_mes||0):"N/A"}),e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["Meta: ",x?.metricas?P(x.metricas.meta_mes||0):"N/A"]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:x?.metricas?`${Math.round(x.metricas.percentual_meta||0)}% atingido`:"N/A"})]})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-md border border-gray-200 p-4 relative",children:[e.jsx("div",{className:"absolute top-3 right-3",children:e.jsx("div",{className:"bg-green-50 p-2 rounded-full",children:e.jsx(xe,{className:"h-5 w-5 text-green-600"})})}),e.jsxs("div",{className:"pr-12",children:[e.jsx("p",{className:"text-xs font-medium text-gray-600",children:"Óticas Positivadas"}),e.jsx("p",{className:"text-xl font-bold text-gray-900 mt-1",children:x?.metricas?`${x.metricas.oticas_positivadas||0} ${(x.metricas.oticas_positivadas||0)===1?"ótica":"óticas"}`:"N/A"}),e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["Meta: ",x?.metricas?`${Math.round(x.metricas.percentual_meta||0)}% atingido`:"N/A"]})]})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-md border border-gray-200 p-4 relative",children:[e.jsx("div",{className:"absolute top-3 right-3",children:e.jsx("div",{className:"bg-yellow-50 p-2 rounded-full",children:e.jsx(fs,{className:"h-5 w-5 text-yellow-600"})})}),e.jsxs("div",{className:"pr-12",children:[e.jsx("p",{className:"text-xs font-medium text-gray-600",children:"Meta Geral"}),e.jsxs("p",{className:"text-xl font-bold text-gray-900 mt-1",children:[n.length>0?Math.round(n.reduce((i,f)=>i+f.percentual,0)/n.length):0,"%"]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Média dos clientes"})]})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-md border border-gray-200 p-4 relative",children:[e.jsx("div",{className:"absolute top-3 right-3",children:e.jsx("div",{className:"bg-red-50 p-2 rounded-full",children:e.jsx(G,{className:"h-5 w-5 text-red-600"})})}),e.jsxs("div",{className:"pr-12",children:[e.jsx("p",{className:"text-xs font-medium text-gray-600",children:"Sem Vendas +90d"}),e.jsxs("p",{className:"text-xl font-bold text-red-600 mt-1",children:[_?.clientes_sem_vendas_90d||n.filter(i=>i.percentual===0||i.vendido===0).length," óticas"]}),e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["De ",_?.total_clientes||n.length," total"]})]})]})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-md border border-gray-200 p-6 mb-6",children:[e.jsxs("div",{className:"flex items-center mb-6",children:[e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"lucide lucide-map-pin h-5 w-5 text-primary mr-2","aria-hidden":"true",children:[e.jsx("path",{d:"M20 10c0 4.993-5.539 10.193-7.399 11.799a1 1 0 0 1-1.202 0C9.539 20.193 4 14.993 4 10a8 8 0 0 1 16 0"}),e.jsx("circle",{cx:"12",cy:"10",r:"3"})]}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Top 10 Cidades"})]}),e.jsx("div",{className:"space-y-3",children:p?[...Array(10)].map((i,f)=>e.jsxs("div",{className:"flex items-center justify-between animate-pulse",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"w-6 h-3 bg-gray-200 rounded mr-2"}),e.jsx("div",{className:"w-20 h-3 bg-gray-200 rounded"})]}),e.jsx("div",{className:"w-16 h-3 bg-gray-200 rounded"})]},f)):x?.top10Cidades&&x.top10Cidades.length>0?x.top10Cidades.map(i=>e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsxs("span",{className:"text-xs font-medium text-gray-500 w-6",children:["#",i.posicao]}),e.jsx("span",{className:"text-xs font-medium text-gray-900",children:i.cidade})]}),e.jsx("span",{className:"text-xs font-medium text-gray-900",children:P(i.valor_vendas)})]},i.cidade)):e.jsxs("div",{className:"text-center py-4 text-gray-500",children:[e.jsx("p",{className:"text-sm",children:$(r,"dashboard").title}),e.jsx("p",{className:"text-xs",children:$(r,"dashboard").subtitle})]})})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-md border border-gray-200 p-6 mb-6",children:[e.jsxs("div",{className:"flex items-center mb-6",children:[e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"lucide lucide-building h-5 w-5 text-primary mr-2","aria-hidden":"true",children:[e.jsx("rect",{width:"16",height:"20",x:"4",y:"2",rx:"2",ry:"2"}),e.jsx("path",{d:"M9 22v-4h6v4"}),e.jsx("path",{d:"M8 6h.01"}),e.jsx("path",{d:"M16 6h.01"}),e.jsx("path",{d:"M12 6h.01"}),e.jsx("path",{d:"M12 10h.01"}),e.jsx("path",{d:"M12 14h.01"}),e.jsx("path",{d:"M16 10h.01"}),e.jsx("path",{d:"M16 14h.01"}),e.jsx("path",{d:"M8 10h.01"}),e.jsx("path",{d:"M8 14h.01"})]}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Top 20 Clientes"})]}),e.jsxs("div",{className:"max-h-96 overflow-y-auto",children:[e.jsxs("div",{className:"grid grid-cols-12 gap-2 text-[10px] font-semibold text-gray-600 border-b border-gray-200 pb-2 mb-2 px-2",children:[e.jsx("div",{className:"col-span-5 text-left",children:"Cliente"}),e.jsxs("div",{className:"col-span-2 text-left flex items-center",children:[e.jsx("span",{children:"Rota"}),e.jsx("button",{onClick:k,className:"ml-1 p-0.5 hover:bg-gray-100 rounded transition-colors",children:t==="asc"?e.jsx(X,{className:"h-2.5 w-2.5"}):t==="desc"?e.jsx(J,{className:"h-2.5 w-2.5"}):e.jsxs("div",{className:"flex flex-col",children:[e.jsx(X,{className:"h-1.5 w-1.5 -mb-0.5"}),e.jsx(J,{className:"h-1.5 w-1.5"})]})})]}),e.jsxs("div",{className:"col-span-5 text-center flex items-center justify-center",children:[e.jsx("span",{children:"Performance"}),e.jsx("button",{onClick:g,className:"ml-1 p-0.5 hover:bg-gray-100 rounded transition-colors",children:l==="desc"?e.jsx(J,{className:"h-2.5 w-2.5"}):l==="asc"?e.jsx(X,{className:"h-2.5 w-2.5"}):e.jsxs("div",{className:"flex flex-col",children:[e.jsx(X,{className:"h-1.5 w-1.5 -mb-0.5"}),e.jsx(J,{className:"h-1.5 w-1.5"})]})})]})]}),p?e.jsxs("div",{className:"flex items-center justify-center py-8",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-primary"}),e.jsx("span",{className:"ml-2 text-sm text-gray-600",children:"Carregando dados..."})]}):C.length>0?(()=>{let i=[...C].sort((f,y)=>y.vendido-f.vendido).slice(0,20).map((f,y)=>({...f,posicaoOriginal:y+1}));return t==="asc"?i.sort((f,y)=>f.rota.localeCompare(y.rota)):t==="desc"?i.sort((f,y)=>y.rota.localeCompare(f.rota)):l==="desc"?i.sort((f,y)=>y.percentual-f.percentual):l==="asc"?i.sort((f,y)=>f.percentual-y.percentual):i.sort((f,y)=>y.vendido-f.vendido),i})().map(i=>{const f=Math.max(i.meta,i.vendido),y=i.meta/f*100,S=i.vendido/f*100,D=i.vendido>i.meta,L=i.nome.length>20?i.nome.substring(0,20)+"...":i.nome;return e.jsxs("div",{className:"grid grid-cols-12 gap-2 items-center py-1.5 hover:bg-gray-50 rounded-lg px-2 transition-colors",children:[e.jsxs("div",{className:"col-span-5 flex items-center gap-1.5",children:[e.jsx("span",{className:"text-[10px] font-bold text-gray-700 w-3 text-right",children:i.posicaoOriginal}),e.jsx("span",{className:"text-xs text-gray-900 truncate",children:L})]}),e.jsx("div",{className:"col-span-2 text-left",children:e.jsx("span",{className:"text-[10px] text-gray-600",children:i.rota})}),e.jsxs("div",{className:"col-span-5 space-y-1",children:[e.jsxs("div",{className:"text-right text-[9px] text-gray-600",children:[e.jsxs("span",{className:"font-medium",children:["VD ",(i.vendido/1e3).toFixed(0),"k"]}),e.jsxs("span",{className:"text-gray-400",children:[" / MT ",(i.meta/1e3).toFixed(0),"k"]})]}),e.jsxs("div",{className:"relative w-full h-1.5 bg-gray-400 rounded-sm overflow-hidden",children:[e.jsx("div",{className:"absolute top-0 left-0 h-full bg-gray-300 transition-all duration-500",style:{width:`${y}%`}}),e.jsx("div",{className:`absolute top-0 left-0 h-full transition-all duration-500 ${D?"bg-primary":"bg-blue-500"}`,style:{width:`${S}%`}})]})]})]},i.codigo_cliente||i.nome)}):e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx("p",{className:"text-sm",children:$(r,"clientes").title}),e.jsx("p",{className:"text-xs",children:$(r,"clientes").subtitle})]})]})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-md border border-gray-200 p-6",children:[e.jsxs("div",{className:"flex items-center mb-6",children:[e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"lucide lucide-target h-5 w-5 text-primary mr-2","aria-hidden":"true",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("circle",{cx:"12",cy:"12",r:"6"}),e.jsx("circle",{cx:"12",cy:"12",r:"2"})]}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Ranking Rotas"})]}),p?e.jsx("div",{className:"space-y-4",children:[...Array(4)].map((i,f)=>e.jsx("div",{className:"animate-pulse",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-12 h-3 bg-gray-200 rounded"}),e.jsx("div",{className:"flex-1 h-5 bg-gray-200 rounded"})]})},f))}):x?.rankingRotas&&x.rankingRotas.length>0?e.jsx("div",{children:e.jsxs("div",{children:[e.jsx("div",{className:"space-y-2 px-2 sm:px-4",children:x.rankingRotas.map(i=>e.jsxs("div",{className:"",children:[e.jsx("div",{className:"mb-1",children:e.jsx("span",{className:"text-xs sm:text-sm text-gray-700 font-medium",children:i.rota})}),e.jsx("div",{className:"relative",children:e.jsxs("div",{className:"h-3 sm:h-4 bg-gray-200 rounded relative",children:[e.jsx("div",{className:"h-3 sm:h-4 bg-primary rounded transition-all duration-300 relative flex items-center justify-center",style:{width:`${Math.min(i.percentual_meta,100)}%`},children:e.jsxs("span",{className:"text-[9px] sm:text-[10px] text-white font-medium",children:[Math.round(i.percentual_meta),"%"]})}),e.jsx("div",{className:"absolute right-1 top-0 h-3 sm:h-4 flex items-center",children:e.jsxs("span",{className:"text-[9px] sm:text-[10px] text-gray-600 font-medium bg-white/90 px-1 rounded shadow-sm",children:[ae(i.vendido_2025),"/",ae(i.meta_2025)]})})]})})]},i.rota))}),e.jsxs("div",{className:"flex items-center justify-center mt-3 space-x-4",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"w-2.5 h-2.5 bg-gray-200 rounded mr-1.5"}),e.jsx("span",{className:"text-[10px] sm:text-xs text-gray-600 font-medium",children:"Meta"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"w-2.5 h-2.5 bg-primary rounded mr-1.5"}),e.jsx("span",{className:"text-[10px] sm:text-xs text-gray-600 font-medium",children:"Vendido"})]})]})]})}):e.jsx("div",{className:"text-center py-8 text-gray-500",children:e.jsx("p",{className:"text-sm",children:$(r,"rotas").title})})]})]})]})};async function Ms(s,r){const{data:{user:a},error:t}=await j.auth.getUser();if(t||!a)throw new Error("Usuário não autenticado");console.log("👥 Buscando clientes para vendedor:",{userId:a.id,cidade:r});const o=r?"vw_clientes_completo":"vw_top20_clientes";console.log("🔍 DECISÃO DA VIEW:",{cidade:r,temCidade:!!r,viewEscolhida:o});let l=j.from(o).select(`
      codigo_cliente,
      nome_fantasia,
      cidade,
      bairro,
      rota,
      vendedor_uuid,
      valor_vendas_2025,
      meta_2025,
      percentual_atingimento,
      ${r?"status_financeiro, dias_sem_comprar, oportunidade, valor_limite_credito, acao_recomendada":"ranking"}
    `).eq("vendedor_uuid",a.id);r&&(l=l.eq("cidade",r)),console.log("🚀 EXECUTANDO QUERY...",{viewName:o,temFiltoCidade:!!r});const{data:h,error:n}=await l.order(r?"nome_fantasia":"ranking");if(console.log("📊 RESULTADO DA QUERY:",{viewName:o,error:n,dataCount:h?.length||0,primeirosDados:h?.slice(0,2)}),n)throw console.error("Erro ao buscar clientes:",n),n;return h||[]}function $s(s){if(!s)return"bg-gray-50";const r=s.toLowerCase();return r.includes("urgente")||r.includes("bloqueio")||r.includes("vai perder")||r.includes("cobrança")||r.includes("última tentativa")||r.includes("resolver situação")?"bg-red-50 border-red-200":r.includes("reconquistar")||r.includes("aumentar frequência")||r.includes("reativar")||r.includes("desenvolver")||r.includes("ação de reativação")||r.includes("avaliar manutenção")?"bg-yellow-50 border-yellow-200":r.includes("manter")||r.includes("foco total")||r.includes("foco em")||r.includes("primeira venda")?"bg-green-50 border-green-200":"bg-gray-50"}const Ds=()=>{const s=U(),{rotaId:r,cidadeNome:a}=H(),{user:t,logout:o}=q();V();const[l,h]=u.useState([]),[n,c]=u.useState(!0),[x,v]=u.useState(!1),_=u.useRef(null),[w,p]=u.useState(""),[N,m]=u.useState("nome"),E=r?decodeURIComponent(r):null,b=a?decodeURIComponent(a):null;u.useEffect(()=>{const d=i=>{_.current&&!_.current.contains(i.target)&&v(!1)};return document.addEventListener("mousedown",d),()=>document.removeEventListener("mousedown",d)},[]),u.useEffect(()=>{I()},[t,b]);async function I(){try{c(!0),console.log("🔍 Carregando clientes para cidade:",b);const d=await Ms(void 0,b||void 0);console.log("✅ Clientes carregados:",d),h(d)}catch(d){console.error("Erro ao carregar clientes:",d)}finally{c(!1)}}const C=d=>d.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^\w\s]/gi,"").toLowerCase().trim(),k=d=>new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL",minimumFractionDigits:0,maximumFractionDigits:0}).format(d||0),g=l.filter(d=>{const i=C(w);return C(d.nome_fantasia).includes(i)||C(d.codigo_cliente.toString()).includes(i)}).sort((d,i)=>{switch(N){case"bairro-az":return(d.bairro||"").localeCompare(i.bairro||"");case"bairro-za":return(i.bairro||"").localeCompare(d.bairro||"");case"maior-oportunidade":return(i.oportunidade||0)-(d.oportunidade||0);case"menor-oportunidade":return(d.oportunidade||0)-(i.oportunidade||0);case"dsv":return(i.dias_sem_comprar||0)-(d.dias_sem_comprar||0);default:return d.nome_fantasia.localeCompare(i.nome_fantasia)}});return n?e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"Carregando clientes..."})]})}):e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx("header",{className:"bg-primary text-white shadow-lg",children:e.jsx("div",{className:"max-w-7xl mx-auto px-3 sm:px-6 lg:px-8",children:e.jsxs("div",{className:"flex items-center justify-between h-14 relative",children:[e.jsx("div",{className:"flex items-center",children:e.jsx("button",{onClick:()=>s(`/rotas/${encodeURIComponent(E||"")}/cidades`),className:"p-1.5 hover:bg-white/10 rounded-full transition-colors mr-2",children:e.jsx(z,{className:"h-4 w-4"})})}),e.jsx("div",{className:"flex items-center absolute left-1/2 transform -translate-x-1/2",children:e.jsx("h1",{className:"text-lg font-bold",children:"Copiloto"})}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("div",{className:"flex items-center space-x-1.5",children:[e.jsx(B,{className:"h-4 w-4"}),e.jsx("span",{className:"text-sm",children:t?.apelido||t?.nome||t?.email||"Usuário"})]}),e.jsx("button",{onClick:()=>{o(),s("/")},className:"p-1.5 hover:bg-white/10 rounded-full transition-colors",children:e.jsx(O,{className:"h-4 w-4"})})]})]})})}),e.jsxs("main",{className:"max-w-7xl mx-auto px-3 sm:px-6 lg:px-8 py-4 lg:py-8",children:[(E||b)&&e.jsx("div",{className:"mb-4 px-2",children:e.jsxs("div",{className:"flex items-center text-sm text-gray-600",children:[E&&e.jsxs("span",{children:["Rota: ",e.jsx("span",{className:"font-semibold text-primary",children:E})]}),E&&b&&e.jsx("span",{className:"mx-2",children:"•"}),b&&e.jsxs("span",{children:["Cidade: ",e.jsx("span",{className:"font-semibold text-primary",children:b})]})]})}),e.jsxs("div",{className:"mb-4 flex items-center gap-3",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(Q,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"Buscar Óticas...",value:w,onChange:d=>p(d.target.value),className:"w-full pl-9 pr-4 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"})]}),e.jsxs("div",{className:"relative flex-shrink-0",ref:_,children:[e.jsx("button",{className:"p-2 border border-gray-300 rounded-lg hover:bg-gray-50",onClick:()=>v(!x),children:e.jsx(pe,{className:"h-4 w-4 text-gray-600"})}),x&&e.jsxs("div",{className:"absolute right-0 top-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg z-10 min-w-36",children:[e.jsx("button",{className:"w-full px-3 py-2 text-xs text-left hover:bg-gray-50 border-b border-gray-200",onClick:()=>{m("bairro-az"),v(!1)},children:"A-Z"}),e.jsx("button",{className:"w-full px-3 py-2 text-xs text-left hover:bg-gray-50 border-b border-gray-200",onClick:()=>{m("bairro-za"),v(!1)},children:"Z-A"}),e.jsx("button",{className:"w-full px-3 py-2 text-xs text-left hover:bg-gray-50 border-b border-gray-200",onClick:()=>{m("bairro"),v(!1)},children:"Bairro"}),e.jsx("button",{className:"w-full px-3 py-2 text-xs text-left hover:bg-gray-50 border-b border-gray-200",onClick:()=>{m("maior-oportunidade"),v(!1)},children:"Maior Oport"}),e.jsx("button",{className:"w-full px-3 py-2 text-xs text-left hover:bg-gray-50",onClick:()=>{m("menor-oportunidade"),v(!1)},children:"Menor Oport"})]})]})]}),e.jsx("div",{className:"space-y-3",children:g.map(d=>{const i=$s(d.acao_recomendada);return e.jsx("div",{className:`bg-white rounded-lg shadow-md border border-gray-200 p-4 hover:shadow-lg hover:border-gray-300 transition-all cursor-pointer ${i}`,onClick:()=>{console.log("Clicou no cliente:",d.codigo_cliente);const f=E?encodeURIComponent(E):"sem-rota",y=b?encodeURIComponent(b):"sem-cidade",S=`/rotas/${f}/cidades/${y}/clientes/${d.codigo_cliente}/detalhes`;console.log("Navegando para:",S),s(S)},children:e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1.5",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("h3",{className:"text-base font-semibold text-gray-900",children:d.nome_fantasia}),e.jsx("span",{className:`px-2 py-0.5 rounded-full text-xs font-medium ${d.status_financeiro==="INADIMPLENTE"?"bg-red-100 text-red-800":"bg-green-100 text-green-800"}`,children:d.status_financeiro})]}),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx("span",{className:"text-xs text-gray-600",children:"DSV:"}),e.jsxs("span",{className:"text-xs font-semibold text-red-600",children:[d.dias_sem_comprar||0,"d"]})]})]}),e.jsxs("p",{className:"text-xs text-gray-600 mb-2 leading-tight",children:["Código: ",d.codigo_cliente]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-xs leading-tight",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-green-600",children:"Oportunidade:"}),e.jsx("span",{className:"ml-1 font-semibold text-green-700",children:k(d.oportunidade)})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("span",{className:"text-gray-600",children:"Limit Créd:"}),e.jsx("span",{className:"ml-1 font-semibold text-gray-800",children:k(d.valor_limite_credito)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-blue-600",children:"Meta:"}),e.jsx("span",{className:"ml-1 font-semibold text-blue-700",children:k(d.meta_2025)})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("span",{className:"text-gray-600",children:"Bairro:"}),e.jsx("span",{className:"ml-1 font-semibold text-gray-800",children:d.bairro||"-"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-purple-600",children:"Vendido:"}),e.jsx("span",{className:"ml-1 font-semibold text-purple-700",children:k(d.valor_vendas_2025)})]}),e.jsx("div",{})]}),d.acao_recomendada&&e.jsx("div",{className:"mt-3 pt-3 border-t border-gray-200",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(he,{className:"h-4 w-4 mt-0.5 flex-shrink-0 text-gray-600"}),e.jsx("p",{className:"text-xs font-medium text-gray-900 leading-tight",children:d.acao_recomendada})]})})]})},d.codigo_cliente)})}),g.length===0&&e.jsxs("div",{className:"text-center py-12 text-gray-500",children:[e.jsx("p",{className:"text-lg mb-2",children:$(t,"clientes").title}),e.jsx("p",{className:"text-sm",children:w?"Tente ajustar os filtros para encontrar os clientes desejados.":$(t,"clientes").subtitle})]})]})]})};async function qs(){try{console.log("🛣️ Buscando rotas via vw_metricas_por_rota...");const{data:{session:s},error:r}=await j.auth.getSession();if(r)throw console.error("❌ Erro ao obter sessão:",r),new Error("Erro de autenticação: "+r.message);if(!s)throw console.error("❌ Usuário não autenticado"),new Error("Usuário não autenticado");console.log("🔐 Sessão ativa:",{userId:s.user.id,email:s.user.email});const{data:a,error:t}=await j.from("vw_metricas_por_rota").select("*").eq("vendedor_uuid",s.user.id).order("rota",{ascending:!0});if(console.log("🛣️ Resposta da view vw_metricas_por_rota:",{dadosCount:a?.length||0,primeirosDados:a?.slice(0,3),error:t}),t)throw console.error("❌ Erro ao buscar métricas das rotas:",t),t;if(!a||a.length===0)return console.log("⚠️ View vw_metricas_por_rota retornou dados vazios - possível problema de RLS"),[];console.log("🔍 Verificando consistência dos dados retornados...");try{const{data:l}=await j.from("vw_clientes_completo").select("rota").limit(1);if(l&&l.length>0){const h=l[0].rota,n=a.map(c=>c.rota);h&&!n.includes(h)?(console.warn("⚠️ Inconsistência detectada: Rota do cliente não encontrada nas rotas retornadas"),console.warn("Rota do cliente:",h),console.warn("Rotas retornadas:",n)):console.log("✅ Consistência verificada: Dados parecem estar corretos")}}catch(l){console.warn("⚠️ Erro na verificação de consistência:",l)}const o=a.map(l=>({nome:l.rota,totalCidades:l.total_cidades||0,totalOticas:l.total_clientes||0,somaOportunidades:l.soma_oportunidades||0,semVendas90d:l.clientes_sem_venda_90d||0,status:"Ativo"}));return console.log(`✅ ${o.length} rotas processadas`),o}catch(s){throw console.error("💥 Erro ao buscar rotas completo:",s),s}}function As(s){return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL",minimumFractionDigits:0,maximumFractionDigits:0}).format(s)}function te(s){return s.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^\w\s]/gi,"").toLowerCase().trim()}const Ts=()=>{const s=U(),{user:r,logout:a}=q();V();const[t,o]=u.useState(""),[l,h]=u.useState([]),[n,c]=u.useState(!0),[x,v]=u.useState(null);u.useEffect(()=>{_()},[r]);async function _(){try{if(c(!0),v(null),!r?.id){console.log("❌ Usuário não autenticado, aguardando..."),c(!1);return}console.log("🔍 Carregando rotas para usuário:",{userId:r.id,email:r.email}),await new Promise(m=>setTimeout(m,500));const{data:{session:p}}=await j.auth.getSession();p||(console.log("❌ Sessão não encontrada, tentando novamente..."),await new Promise(m=>setTimeout(m,1e3)));const N=await qs();console.log("✅ Rotas carregadas:",N),h(N)}catch(p){console.error("💥 Erro ao carregar rotas:",p),v(p instanceof Error?p.message:"Erro desconhecido"),h([])}finally{c(!1)}}const w=l.filter(p=>{const N=te(t);return te(p.nome).includes(N)});return e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx("header",{className:"bg-primary text-white shadow-lg",children:e.jsx("div",{className:"max-w-7xl mx-auto px-3 sm:px-6 lg:px-8",children:e.jsxs("div",{className:"flex items-center justify-between h-14 relative",children:[e.jsx("div",{className:"flex items-center",children:e.jsx("button",{onClick:()=>s("/dashboard"),className:"p-1.5 hover:bg-white/10 rounded-full transition-colors mr-2",children:e.jsx(z,{className:"h-4 w-4"})})}),e.jsx("div",{className:"flex items-center absolute left-1/2 transform -translate-x-1/2",children:e.jsx("h1",{className:"text-lg font-bold",children:"Copiloto"})}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("div",{className:"flex items-center space-x-1.5",children:[e.jsx(B,{className:"h-4 w-4"}),e.jsx("span",{className:"text-sm",children:r?.apelido||r?.nome||r?.email||"Usuário"})]}),e.jsx("button",{onClick:()=>{a(),s("/")},className:"p-1.5 hover:bg-white/10 rounded-full transition-colors",children:e.jsx(O,{className:"h-4 w-4"})})]})]})})}),e.jsxs("main",{className:"max-w-7xl mx-auto px-3 sm:px-6 lg:px-8 py-4 lg:py-8",children:[e.jsx("div",{className:"mb-4",children:e.jsxs("div",{className:"relative",children:[e.jsx(Q,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"Buscar rotas...",value:t,onChange:p=>o(p.target.value),className:"w-full pl-9 pr-4 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"})]})}),n?e.jsxs("div",{className:"flex items-center justify-center py-12",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"}),e.jsx("span",{className:"ml-2 text-gray-600",children:"Carregando rotas..."})]}):x?e.jsxs("div",{className:"text-center py-12 text-red-600",children:[e.jsx("p",{className:"text-lg mb-2",children:"Erro ao carregar rotas"}),e.jsx("p",{className:"text-sm",children:x}),e.jsx("button",{onClick:_,className:"mt-4 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors",children:"Tentar novamente"})]}):e.jsx("div",{className:"space-y-3",children:w.length>0?w.map((p,N)=>e.jsx("div",{className:"bg-white rounded-lg shadow-md border border-gray-200 p-4 hover:shadow-lg hover:border-gray-300 transition-all cursor-pointer",onClick:()=>s(`/rotas/${encodeURIComponent(p.nome||"sem-rota")}/cidades`),children:e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-1.5",children:[e.jsx(ge,{className:"h-4 w-4 text-primary"}),e.jsx("h3",{className:"text-base font-semibold text-gray-900",children:p.nome||"Sem Rota"})]}),e.jsx("div",{className:"mb-2"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-xs leading-tight",children:[e.jsx("div",{children:e.jsx("span",{className:"text-green-600",children:"Oportunidade:"})}),e.jsx("div",{className:"text-right",children:e.jsx("p",{className:"font-semibold text-green-700",children:As(p.somaOportunidades)})}),e.jsxs("div",{children:[e.jsx("span",{className:"text-blue-600",children:"Cidades:"}),e.jsx("span",{className:"font-semibold text-blue-700 ml-1",children:p.totalCidades})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("span",{className:"text-purple-600",children:"Óticas:"}),e.jsx("span",{className:"font-semibold text-purple-700 ml-1",children:p.totalOticas})]}),e.jsx("div",{children:e.jsx("span",{className:"text-red-600",children:"Sem Vendas +90d:"})}),e.jsx("div",{className:"text-right",children:e.jsxs("span",{className:"font-semibold text-red-700",children:[p.semVendas90d," ",p.semVendas90d===1?"ótica":"óticas"]})})]})]})})},p.nome||N)):e.jsxs("div",{className:"text-center py-12 text-gray-500",children:[e.jsx("p",{className:"text-lg mb-2",children:$(r,"rotas").title}),e.jsx("p",{className:"text-sm",children:t?"Tente ajustar o filtro de busca.":$(r,"rotas").subtitle})]})})]})]})};async function Us(s){try{console.log("🏙️ Buscando cidades via vw_cidades_completo...",{rota:s});const{data:{session:r},error:a}=await j.auth.getSession();if(a)throw console.error("❌ Erro ao obter sessão:",a),new Error("Erro de autenticação: "+a.message);if(!r)throw console.error("❌ Usuário não autenticado"),new Error("Usuário não autenticado");console.log("🔐 Sessão ativa:",{userId:r.user.id,email:r.user.email});let t=j.from("vw_cidades_completo").select("*").eq("vendedor_uuid",r.user.id);s===null?t=t.is("rota",null).gt("total_oticas",0):s&&(t=t.eq("rota",s));const{data:o,error:l}=await t.order("cidade",{ascending:!0});if(console.log("🏙️ Resposta da view vw_cidades_completo:",{dadosCount:o?.length||0,primeirosDados:o?.slice(0,3),error:l}),l)throw console.error("❌ Erro ao buscar cidades:",l),l;return!o||o.length===0?(console.log("⚠️ View vw_cidades_completo retornou dados vazios - possível problema de RLS"),[]):(o.forEach(n=>{const c=(n.status_ativo||0)+(n.status_pendente||0)+(n.status_inativo||0)+(n.status_inadimplente||0);c!==(n.total_oticas||0)&&console.warn(`🔍 Inconsistência em ${n.cidade}: Total=${n.total_oticas}, Soma=${c}`)}),o.map(n=>({nome:n.cidade,rota:n.rota||"SEM ROTA",clientes:{AT:n.status_ativo||0,PEN:n.status_pendente||0,INA:(n.status_inativo||0)+(n.status_inadimplente||0)},somaOportunidades:n.soma_oportunidades||0,saldoMetas:n.saldo_metas||0,clientesSemVenda90d:(n.total_oticas||0)-(n.oticas_ativas||0),totalClientes:n.total_oticas||0})))}catch(r){throw console.error("Erro ao buscar cidades completo:",r),r}}function oe(s){return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL",minimumFractionDigits:0,maximumFractionDigits:0}).format(s)}function ne(s){return s.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^\w\s]/gi,"").toLowerCase().trim()}const Ls=()=>{const s=U(),{rotaId:r}=H(),{user:a,logout:t}=q();V();const[o,l]=u.useState(""),[h,n]=u.useState([]),[c,x]=u.useState(!0),[v,_]=u.useState(null),w=r?decodeURIComponent(r):null;u.useEffect(()=>{p()},[a,w]);async function p(){try{if(x(!0),_(null),!a?.id){console.log("❌ Usuário não autenticado, aguardando...");return}console.log("🔍 Carregando cidades para usuário:",{userId:a.id,email:a.email,rota:w});const m=await Us(w==="sem-rota"?null:w||void 0);console.log("✅ Cidades carregadas:",m),n(m)}catch(m){console.error("💥 Erro ao carregar cidades:",m),_(m instanceof Error?m.message:"Erro desconhecido"),n([])}finally{x(!1)}}const N=h.filter(m=>{const E=ne(o);return ne(m.nome).includes(E)});return e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx("header",{className:"bg-primary text-white shadow-lg",children:e.jsx("div",{className:"max-w-7xl mx-auto px-3 sm:px-6 lg:px-8",children:e.jsxs("div",{className:"flex items-center justify-between h-14 relative",children:[e.jsx("div",{className:"flex items-center",children:e.jsx("button",{onClick:()=>s("/rotas"),className:"p-1.5 hover:bg-white/10 rounded-full transition-colors mr-2",children:e.jsx(z,{className:"h-4 w-4"})})}),e.jsx("div",{className:"flex items-center absolute left-1/2 transform -translate-x-1/2",children:e.jsx("h1",{className:"text-lg font-bold",children:"Copiloto"})}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("div",{className:"flex items-center space-x-1.5",children:[e.jsx(B,{className:"h-4 w-4"}),e.jsx("span",{className:"text-sm",children:a?.apelido||a?.nome||a?.email||"Usuário"})]}),e.jsx("button",{onClick:()=>{t(),s("/")},className:"p-1.5 hover:bg-white/10 rounded-full transition-colors",children:e.jsx(O,{className:"h-4 w-4"})})]})]})})}),e.jsxs("main",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 lg:py-8",children:[w&&e.jsx("div",{className:"mb-4 px-2",children:e.jsxs("div",{className:"flex items-center text-sm text-gray-600",children:[e.jsx("span",{children:"Rota:"}),e.jsx("span",{className:"ml-2 font-semibold text-primary",children:w==="sem-rota"?"Sem Rota":w})]})}),e.jsx("div",{className:"mb-6",children:e.jsxs("div",{className:"relative",children:[e.jsx(Q,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"Buscar cidades...",value:o,onChange:m=>l(m.target.value),className:"w-full pl-10 pr-4 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"})]})}),c?e.jsxs("div",{className:"flex items-center justify-center py-12",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"}),e.jsx("span",{className:"ml-2 text-gray-600",children:"Carregando cidades..."})]}):v?e.jsxs("div",{className:"text-center py-12 text-red-600",children:[e.jsx("p",{className:"text-lg mb-2",children:"Erro ao carregar cidades"}),e.jsx("p",{className:"text-sm",children:v}),e.jsx("button",{onClick:p,className:"mt-4 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors",children:"Tentar novamente"})]}):e.jsx("div",{className:"space-y-3",children:N.length>0?N.map((m,E)=>e.jsx("div",{className:"bg-white rounded-lg shadow-md border border-gray-200 p-4 hover:shadow-lg hover:border-gray-300 transition-all cursor-pointer",onClick:()=>s(`/rotas/${encodeURIComponent(w||"")}/cidades/${encodeURIComponent(m.nome)}/clientes`),children:e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-1.5",children:[e.jsx(ge,{className:"h-4 w-4 text-primary"}),e.jsx("h3",{className:"text-base font-semibold text-gray-900",children:m.nome}),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(xe,{className:"h-4 w-4 text-gray-500"}),e.jsxs("span",{className:"text-xs text-gray-600",children:[m.totalClientes," óticas"]})]})]}),e.jsx("div",{className:"mb-2"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-xs leading-tight mb-2",children:[e.jsx("span",{className:"text-green-600",children:"Soma Oportunidade:"}),e.jsx("p",{className:"font-semibold text-green-700 text-right",children:oe(m.somaOportunidades)}),e.jsx("span",{className:"text-blue-600",children:"Saldo de Metas:"}),e.jsx("p",{className:"font-semibold text-blue-700 text-right",children:oe(m.saldoMetas)}),e.jsx("span",{className:"text-red-600",children:"Sem Vendas +90d:"}),e.jsxs("p",{className:"font-semibold text-red-700 text-right",children:[m.clientesSemVenda90d," ",m.clientesSemVenda90d===1?"ótica":"óticas"]}),e.jsx("span",{className:"text-purple-600",children:"N Lojas:"}),e.jsxs("div",{className:"flex items-center justify-end space-x-2 text-xs",children:[e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx("span",{className:"w-2 h-2 bg-green-500 rounded-full"}),e.jsxs("span",{className:"text-gray-600",children:[m.clientes.AT," AT"]})]}),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx("span",{className:"w-2 h-2 bg-red-500 rounded-full"}),e.jsxs("span",{className:"text-gray-600",children:[m.clientes.PEN," PEN"]})]}),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx("span",{className:"w-2 h-2 bg-yellow-500 rounded-full"}),e.jsxs("span",{className:"text-gray-600",children:[m.clientes.INA," INA"]})]})]})]})]})})},`${m.nome}-${E}`)):e.jsxs("div",{className:"text-center py-12 text-gray-500",children:[e.jsx("p",{className:"text-lg mb-2",children:$(a,"cidades").title}),e.jsx("p",{className:"text-sm",children:o?"Tente ajustar o filtro de busca.":$(a,"cidades").subtitle})]})})]})]})},Z=s=>new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(s||0),Ps=s=>`${Math.round(s||0)}%`,Vs=s=>{if(!s)return"";const r=s.replace(/\D/g,"");return r.length===11?`(${r.slice(0,2)}) ${r.slice(2,7)}-${r.slice(7)}`:s};function Os(s){if(!s)return{categorias:[],totais:{ob:0,pw:0}};const r=[{nome:"RX Feminino",ob:s.rx_fem_ob||0,pw:s.rx_fem_pw||0},{nome:"RX Masculino",ob:s.rx_mas_ob||0,pw:s.rx_mas_pw||0},{nome:"SOL Feminino",ob:s.sol_fem_ob||0,pw:s.sol_fem_pw||0},{nome:"SOL Masculino",ob:s.sol_mas_ob||0,pw:s.sol_mas_pw||0}],a={ob:(s.rx_fem_ob||0)+(s.rx_mas_ob||0)+(s.sol_fem_ob||0)+(s.sol_mas_ob||0),pw:(s.rx_fem_pw||0)+(s.rx_mas_pw||0)+(s.sol_fem_pw||0)+(s.sol_mas_pw||0)};return{categorias:r,totais:a}}const le=()=>{const s=U(),{user:r,logout:a}=q();V();const{id:t,rotaId:o,cidadeNome:l,clienteId:h}=H(),[n,c]=u.useState(null),[x,v]=u.useState(!0),[_,w]=u.useState(null),p=h||t,N=o?decodeURIComponent(o):null,m=l?decodeURIComponent(l):null,E=()=>{s(N&&m?`/rotas/${encodeURIComponent(N)}/cidades/${encodeURIComponent(m)}/clientes`:"/clientes")};if(u.useEffect(()=>{async function C(){if(!p){console.log("❌ ID não fornecido");return}const k=parseInt(p);if(isNaN(k)){console.log("❌ ID inválido:",p),w("ID do cliente inválido"),v(!1);return}console.log("🔍 Carregando cliente com ID:",k);try{v(!0),console.log("📞 Buscando dados diretamente da view para ID:",k);const{data:{user:g},error:d}=await j.auth.getUser();if(d||!g)throw new Error("Usuário não autenticado");const{data:i,error:f}=await j.from("vw_clientes_completo").select("*").eq("codigo_cliente",k).eq("vendedor_uuid",g.id).single();if(f)throw f;console.log("✅ Dados básicos recebidos:",i);const{data:y,error:S}=await j.from("analise_rfm").select(`
            qtd_compras_2024, 
            qtd_compras_2025, 
            valor_vendas_2024, 
            valor_vendas_2025, 
            meta_2025, 
            percentual_atingimento, 
            estrelas, 
            acao_recomendada, 
            previsao_pedido, 
            dias_sem_comprar,
            codigo_cliente,
            data_analise
          `).eq("codigo_cliente",k).order("data_analise",{ascending:!1}).limit(1).maybeSingle();S&&console.warn("⚠️ Erro ao buscar dados RFM:",S),console.log("✅ Dados RFM recebidos:",y);const{data:D,error:L}=await j.from("vw_metricas_categoria_cliente").select("*").eq("codigo_cliente",k).maybeSingle();L&&console.warn("⚠️ Erro ao buscar métricas de categoria:",L),console.log("✅ Métricas categoria recebidas:",D);const M={...i,...y||{},...D||{}};c(M),console.log("🔍 DEBUG - Dados carregados:",{codigo_cliente:M.codigo_cliente,qtd_2024:M.qtd_compras_2024,qtd_2025:M.qtd_compras_2025,tipo_qtd_2024:typeof M.qtd_compras_2024,tipo_qtd_2025:typeof M.qtd_compras_2025,tem_qtd_2024:"qtd_compras_2024"in M,tem_qtd_2025:"qtd_compras_2025"in M,valor_exato_2024:M.qtd_compras_2024,valor_exato_2025:M.qtd_compras_2025,dados_completos:M})}catch(g){console.error("❌ Erro ao carregar cliente:",g);let d=`Erro ao carregar dados do cliente ID ${t}`;g instanceof Error?d+=`

Detalhes do erro: ${g.message}`:typeof g=="object"&&g!==null&&(d+=`

Detalhes: ${JSON.stringify(g,null,2)}`),w(d)}finally{v(!1),console.log("🏁 Loading finalizado")}}C()},[p]),x)return e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"Carregando dados do cliente..."})]})});if(_)return e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center max-w-2xl mx-auto p-6",children:[e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4 mb-4",children:e.jsx("pre",{className:"text-red-600 text-sm text-left whitespace-pre-wrap",children:_})}),e.jsx("button",{onClick:E,className:"bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90",children:"Voltar para Clientes"})]})});if(!n)return e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-gray-600 mb-4",children:"Cliente não encontrado"}),e.jsx("button",{onClick:E,className:"bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90",children:"Voltar para Clientes"})]})});const b={nome:n.nome_fantasia,status:n.status_financeiro,codigo:n.codigo_cliente,dsv:n.dias_sem_comprar,vendas2025:n.valor_vendas_2025,vendas2024:n.valor_vendas_2024,oportunidade:n.oportunidade,meta:n.meta_2025,qtdVendas2025:n.qtd_compras_2025??0,qtdVendas2024:n.qtd_compras_2024??0,percentualMeta:n.percentual_atingimento,acaoRecomendada:n.acao_recomendada,celular:n.celular||"",statusErp:n.status_erp,statusErpDesc:n.status_erp_desc,statusComercial:n.status_comercial,statusDisplay:n.status_display,limiteCredito:n.valor_limite_credito,saldoUtilizado:n.saldo_utilizado,limiteDisponivel:n.limite_disponivel},I=Os(n);return console.log("Cliente ID:",p),console.log("Dados do cliente:",b),console.log("🔍 DEBUG FINAL - Quantidades:",{qtdVendas2025_final:b.qtdVendas2025,qtdVendas2024_final:b.qtdVendas2024,tipo_qtd_2025:typeof b.qtdVendas2025,tipo_qtd_2024:typeof b.qtdVendas2024,origem_qtd_2025:n.qtd_compras_2025,origem_qtd_2024:n.qtd_compras_2024}),console.log("Métricas categoria:",I),e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx("header",{className:"bg-primary text-white shadow-lg",children:e.jsx("div",{className:"max-w-7xl mx-auto px-3 sm:px-6 lg:px-8",children:e.jsxs("div",{className:"flex items-center justify-between h-14 relative",children:[e.jsx("div",{className:"flex items-center",children:e.jsx("button",{onClick:E,className:"p-1.5 hover:bg-white/10 rounded-full transition-colors mr-2",children:e.jsx(z,{className:"h-4 w-4"})})}),e.jsx("div",{className:"flex items-center absolute left-1/2 transform -translate-x-1/2",children:e.jsx("h1",{className:"text-lg font-bold",children:"Copiloto"})}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("div",{className:"flex items-center space-x-1.5",children:[e.jsx(B,{className:"h-4 w-4"}),e.jsx("span",{className:"text-sm",children:r?.apelido||r?.nome||r?.email||"Usuário"})]}),e.jsx("button",{onClick:()=>{a(),s("/")},className:"p-1.5 hover:bg-white/10 rounded-full transition-colors",children:e.jsx(O,{className:"h-4 w-4"})})]})]})})}),e.jsxs("main",{className:"max-w-4xl mx-auto px-3 sm:px-6 lg:px-8 py-4 lg:py-8",children:[(N||m)&&e.jsx("div",{className:"mb-4 px-2",children:e.jsxs("div",{className:"flex items-center text-sm text-gray-600",children:[N&&e.jsxs("span",{children:["Rota: ",e.jsx("span",{className:"font-semibold text-primary",children:N})]}),N&&m&&e.jsx("span",{className:"mx-2",children:"•"}),m&&e.jsxs("span",{children:["Cidade: ",e.jsx("span",{className:"font-semibold text-primary",children:m})]}),(N||m)&&n&&e.jsx("span",{className:"mx-2",children:"•"}),n&&e.jsxs("span",{children:["Cliente: ",e.jsx("span",{className:"font-semibold text-primary",children:n.nome_fantasia})]})]})}),e.jsxs("div",{className:"bg-white rounded-lg shadow-md border border-gray-200 p-4",children:[e.jsxs("div",{className:"mb-4 pb-4 border-b border-gray-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1.5",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("h2",{className:"text-base font-bold text-gray-900",children:b.nome}),e.jsx("span",{className:`px-2 py-0.5 rounded-full text-xs font-medium ${b.status==="ADIMPLENTE"?"bg-green-100 text-green-800":"bg-red-100 text-red-800"}`,children:b.status})]}),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx("span",{className:"text-xs text-gray-600",children:"DSV:"}),e.jsxs("span",{className:"text-xs font-semibold text-red-600",children:[b.dsv,"d"]})]})]}),e.jsxs("p",{className:"text-xs text-gray-600 mb-2 leading-tight",children:["Cód: ",b.codigo]})]}),e.jsx("div",{className:"mb-4 pb-4 border-b border-gray-200",children:e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-xs leading-tight",children:[e.jsxs("div",{className:"leading-tight",children:[e.jsx("span",{className:"text-gray-600",children:"2025: "}),e.jsx("span",{className:"font-semibold",children:Z(b.vendas2025)})]}),e.jsx("div",{className:"text-right leading-tight",children:e.jsxs("span",{className:"text-gray-600",children:["Qnt: ",b.qtdVendas2025]})}),e.jsxs("div",{className:"leading-tight",children:[e.jsx("span",{className:"text-gray-600",children:"2024: "}),e.jsx("span",{className:"font-semibold",children:Z(b.vendas2024)})]}),e.jsx("div",{className:"text-right leading-tight",children:e.jsxs("span",{className:"text-gray-600",children:["Qnt: ",b.qtdVendas2024]})}),e.jsxs("div",{className:"leading-tight",children:[e.jsx("span",{className:"text-green-600",children:"Oport: "}),e.jsx("span",{className:"font-semibold text-green-700",children:Z(b.oportunidade)})]}),e.jsx("div",{}),e.jsxs("div",{className:"leading-tight",children:[e.jsx("span",{className:"text-blue-600",children:"Meta: "}),e.jsx("span",{className:"font-semibold text-blue-700",children:Z(b.meta)})]}),e.jsx("div",{className:"text-right leading-tight",children:e.jsxs("span",{className:"text-gray-600",children:["Ating: ",Ps(b.percentualMeta)]})})]})}),e.jsxs("div",{className:"mb-4 pb-4",children:[e.jsx("h3",{className:"text-base font-semibold text-gray-900 mb-3",children:"Mix de Produtos"}),e.jsx("div",{className:"bg-gray-50 p-4 rounded-lg",children:I.categorias.length>0?e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left",children:[e.jsx("th",{className:"pb-2 text-xs font-medium text-gray-700"}),e.jsx("th",{className:"pb-2 text-right text-xs font-medium text-gray-700",children:"OB"}),e.jsx("th",{className:"pb-2 text-right text-xs font-medium text-gray-700",children:"PW"})]})}),e.jsxs("tbody",{children:[I.categorias.map((C,k)=>e.jsxs("tr",{className:"border-t border-gray-200",children:[e.jsx("td",{className:"py-2 text-xs font-medium text-gray-900",children:C.nome}),e.jsx("td",{className:"py-2 text-right text-xs font-semibold text-gray-900",children:C.ob}),e.jsx("td",{className:"py-2 text-right text-xs font-semibold text-gray-900",children:C.pw})]},k)),e.jsxs("tr",{className:"border-t-2 border-gray-400 font-bold",children:[e.jsx("td",{className:"pt-2 text-xs font-bold text-gray-900",children:"TOTAL"}),e.jsx("td",{className:"pt-2 text-right text-xs font-bold text-gray-900",children:I.totais.ob}),e.jsx("td",{className:"pt-2 text-right text-xs font-bold text-gray-900",children:I.totais.pw})]})]})]}):e.jsx("p",{className:"text-xs text-gray-500 text-center py-4",children:"Nenhum produto encontrado para este cliente"})})]}),e.jsx("div",{className:"pt-4 border-t border-gray-200",children:e.jsxs("div",{className:"space-y-2",children:[e.jsxs("button",{onClick:()=>{b.celular?window.location.href=`tel:${b.celular}`:alert("Cliente sem telefone cadastrado")},className:`w-full py-2.5 rounded-lg font-medium transition-colors flex items-center justify-center gap-2 ${b.celular?"bg-primary text-white hover:bg-primary/90":"bg-gray-300 text-gray-500 cursor-not-allowed"}`,disabled:!b.celular,children:[e.jsx(ve,{className:"h-4 w-4"}),e.jsx("span",{className:"text-sm",children:b.celular?`Ligar (${Vs(b.celular)})`:"Sem telefone"})]}),e.jsxs("button",{onClick:()=>{if(b.celular){const C=b.celular.replace(/\D/g,""),k=C.startsWith("55")?C:`55${C}`;window.open(`https://wa.me/${k}`,"_blank")}else alert("Cliente sem WhatsApp cadastrado")},className:`w-full py-2.5 rounded-lg font-medium transition-colors flex items-center justify-center gap-2 ${b.celular?"bg-green-600 text-white hover:bg-green-700":"bg-gray-300 text-gray-500 cursor-not-allowed"}`,disabled:!b.celular,children:[e.jsx(fe,{className:"h-4 w-4"}),e.jsx("span",{className:"text-sm",children:b.celular?"WhatsApp":"Sem WhatsApp"})]}),e.jsxs("button",{disabled:!0,className:"w-full bg-gray-400 text-white py-2.5 rounded-lg cursor-not-allowed flex items-center justify-center gap-2 opacity-50",children:[e.jsx(xs,{className:"h-4 w-4"}),e.jsx("span",{className:"text-sm",children:"Gravar Áudio (Em breve)"})]})]})})]})]})]})};async function Bs(s){try{const{data:r,error:a}=await j.from("vw_inadimplentes_resumo").select("valor_total").eq("codigo_cliente",s).single();return a?(console.warn(`⚠️ Erro ao buscar valor de inadimplência para cliente ${s}:`,a),0):Number(r?.valor_total||0)}catch(r){return console.warn(`⚠️ Erro ao buscar valor de inadimplência para cliente ${s}:`,r),0}}async function Fs(){try{const{data:{user:s},error:r}=await j.auth.getUser();if(r||!s)throw new Error("Usuário não autenticado");console.log("🚨 Buscando inadimplentes para vendedor:",{userId:s.id});const{data:a,error:t}=await j.from("vw_clientes_completo").select("*").eq("vendedor_uuid",s.id).eq("status_financeiro","INADIMPLENTE").order("dias_sem_comprar",{ascending:!1});if(t)throw console.error("Erro ao buscar clientes inadimplentes:",t),t;if(!a||a.length===0)return[];const{data:o,error:l}=await j.from("vw_inadimplentes").select("codigo_cliente, titulo_uuid, data_vencimento, valor_original, dias_atraso").in("codigo_cliente",a.map(c=>c.codigo_cliente)).order("codigo_cliente",{ascending:!0}).order("data_vencimento",{ascending:!0});l&&console.warn("⚠️ Erro ao buscar títulos de inadimplentes:",l);const h=(o||[]).reduce((c,x)=>(c[x.codigo_cliente]||(c[x.codigo_cliente]=[]),c[x.codigo_cliente].push({numero:x.titulo_uuid,vencimento:new Date(x.data_vencimento).toLocaleDateString("pt-BR"),valor:x.valor_original,dias_atraso:x.dias_atraso}),c),{});return await Promise.all(a.map(async c=>{const x=await Bs(c.codigo_cliente);return{codigo_cliente:c.codigo_cliente,nome_fantasia:c.nome_fantasia,cidade:c.cidade||"Sem cidade",rota:c.rota||"Sem rota",status_financeiro:c.status_financeiro,valor_total_titulos:x,qtd_titulos_abertos:(h[c.codigo_cliente]||[]).length,maior_dias_atraso:c.dias_sem_comprar||0,ultimo_pagamento:null,telefone:c.celular||null,titulos:h[c.codigo_cliente]||[]}}))}catch(s){throw console.error("Erro ao buscar inadimplentes:",s),s}}function zs(s){return s>90?{status:"Crítico",statusColor:"bg-red-100 text-red-800",prioridade:4}:s>60?{status:"Alto",statusColor:"bg-orange-100 text-orange-800",prioridade:3}:s>30?{status:"Médio",statusColor:"bg-yellow-100 text-yellow-800",prioridade:2}:{status:"Baixo",statusColor:"bg-blue-100 text-blue-800",prioridade:1}}function Ws(s){if(!s)return"N/A";const r=s.replace(/\D/g,"");return r.length===11?`(${r.slice(0,2)}) ${r.slice(2,7)}-${r.slice(7)}`:r.length===10?`(${r.slice(0,2)}) ${r.slice(2,6)}-${r.slice(6)}`:s}const Js=()=>{const s=U(),{user:r,logout:a}=q();V();const[t,o]=u.useState(""),[l,h]=u.useState(!1),[n,c]=u.useState("nome"),[x,v]=u.useState([]),[_,w]=u.useState(!0),[p,N]=u.useState(0),m=g=>g.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^\w\s]/gi,"").toLowerCase().trim();u.useEffect(()=>{E()},[r]);async function E(){try{w(!0),console.log("🔍 Carregando inadimplentes para usuário:",r?.id);const g=await Fs();console.log("✅ Inadimplentes carregados:",g);try{const i=await be();i&&(N(i.total_inadimplencia),console.log("✅ Valor total inadimplência carregado:",i.total_inadimplencia))}catch(i){console.warn("⚠️ Erro ao carregar valor total de inadimplência:",i)}const d=g.map(i=>{const{status:f,statusColor:y}=zs(i.maior_dias_atraso);return{id:i.codigo_cliente,nome:i.nome_fantasia,codigo:i.codigo_cliente.toString(),cidade:i.cidade,rota:i.rota,valorTotal:P(i.valor_total_titulos),ultimoPagamento:i.ultimo_pagamento||"N/A",telefone:Ws(i.telefone),titulosAbertos:i.titulos,diasAtraso:i.maior_dias_atraso,status:f,statusColor:y}});v(d)}catch(g){console.error("💥 Erro ao carregar inadimplentes:",g),v([])}finally{w(!1)}}const I=x.filter(g=>{const d=m(t);return m(g.nome).includes(d)||m(g.codigo).includes(d)||m(g.rota).includes(d)}).sort((g,d)=>{switch(n){case"rota":return g.rota.localeCompare(d.rota);case"valor-maior":return parseFloat(d.valorTotal.replace("R$ ","").replace(".","").replace(",","."))-parseFloat(g.valorTotal.replace("R$ ","").replace(".","").replace(",","."));case"valor-menor":return parseFloat(g.valorTotal.replace("R$ ","").replace(".","").replace(",","."))-parseFloat(d.valorTotal.replace("R$ ","").replace(".","").replace(",","."));case"az":return g.nome.localeCompare(d.nome);case"za":return d.nome.localeCompare(g.nome);default:return g.nome.localeCompare(d.nome)}}),C=I.length,k=I.filter(g=>g.diasAtraso>30).length;return e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx("header",{className:"bg-primary text-white shadow-lg",children:e.jsx("div",{className:"max-w-7xl mx-auto px-3 sm:px-6 lg:px-8",children:e.jsxs("div",{className:"flex items-center justify-between h-14 relative",children:[e.jsx("div",{className:"flex items-center",children:e.jsx("button",{onClick:()=>s("/dashboard"),className:"p-1.5 hover:bg-white/10 rounded-full transition-colors mr-2",children:e.jsx(z,{className:"h-4 w-4"})})}),e.jsx("div",{className:"flex items-center absolute left-1/2 transform -translate-x-1/2",children:e.jsx("h1",{className:"text-lg font-bold",children:"Copiloto"})}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("div",{className:"flex items-center space-x-1.5",children:[e.jsx(B,{className:"h-4 w-4"}),e.jsx("span",{className:"text-sm",children:r?.apelido||r?.nome||r?.email||"Usuário"})]}),e.jsx("button",{onClick:()=>{a(),s("/")},className:"p-1.5 hover:bg-white/10 rounded-full transition-colors",children:e.jsx(O,{className:"h-4 w-4"})})]})]})})}),e.jsxs("main",{className:"max-w-7xl mx-auto px-3 sm:px-6 lg:px-8 py-4 lg:py-8",children:[e.jsxs("div",{className:"flex items-center mb-4",children:[e.jsx(G,{className:"h-5 w-5 text-red-600 mr-2"}),e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Clientes Inadimplentes"})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-3 sm:gap-4 mb-6",children:[e.jsxs("div",{className:"bg-white rounded-lg shadow-md border border-gray-200 p-3 sm:p-4",children:[e.jsx("p",{className:"text-[10px] sm:text-xs text-gray-600 mb-1",children:"Total Inadimplentes"}),e.jsx("p",{className:"text-sm sm:text-lg font-bold text-red-600",children:C})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-md border border-gray-200 p-3 sm:p-4",children:[e.jsx("p",{className:"text-[10px] sm:text-xs text-gray-600 mb-1",children:"Valor Total"}),e.jsx("p",{className:"text-sm sm:text-lg font-bold text-red-600",children:P(p)})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-md border border-gray-200 p-3 sm:p-4",children:[e.jsx("p",{className:"text-[10px] sm:text-xs text-gray-600 mb-1",children:"Críticos (>30d)"}),e.jsx("p",{className:"text-sm sm:text-lg font-bold text-red-600",children:k})]})]}),e.jsxs("div",{className:"mb-4 flex items-center gap-3",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(Q,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"Buscar inadimplentes...",value:t,onChange:g=>o(g.target.value),className:"w-full pl-9 pr-4 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"})]}),e.jsxs("div",{className:"relative flex-shrink-0",children:[e.jsx("button",{className:"p-2 border border-gray-300 rounded-lg hover:bg-gray-50",onClick:()=>h(!l),children:e.jsx(pe,{className:"h-4 w-4 text-gray-600"})}),l&&e.jsxs("div",{className:"absolute right-0 top-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg z-10 min-w-32",children:[e.jsx("button",{className:"w-full px-3 py-2 text-xs text-left hover:bg-gray-50 border-b border-gray-200",onClick:()=>{c("rota"),h(!1)},children:"Rota"}),e.jsx("button",{className:"w-full px-3 py-2 text-xs text-left hover:bg-gray-50 border-b border-gray-200",onClick:()=>{c("valor-maior"),h(!1)},children:"Maior Valor"}),e.jsx("button",{className:"w-full px-3 py-2 text-xs text-left hover:bg-gray-50 border-b border-gray-200",onClick:()=>{c("valor-menor"),h(!1)},children:"Menor Valor"}),e.jsx("button",{className:"w-full px-3 py-2 text-xs text-left hover:bg-gray-50 border-b border-gray-200",onClick:()=>{c("az"),h(!1)},children:"A-Z"}),e.jsx("button",{className:"w-full px-3 py-2 text-xs text-left hover:bg-gray-50",onClick:()=>{c("za"),h(!1)},children:"Z-A"})]})]})]}),e.jsx("div",{className:"space-y-3",children:_?e.jsxs("div",{className:"flex items-center justify-center py-12",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"}),e.jsx("span",{className:"ml-2 text-gray-600",children:"Carregando inadimplentes..."})]}):I.length>0?I.map(g=>e.jsx("div",{className:"bg-white rounded-lg shadow-md border border-gray-200 p-4 hover:shadow-lg hover:border-gray-300 transition-all",children:e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-1",children:[e.jsx(G,{className:"h-4 w-4 text-red-500"}),e.jsx("h3",{className:"text-base font-semibold text-gray-900",children:g.nome}),e.jsx("span",{className:`px-2 py-0.5 rounded-full text-xs font-medium ${g.statusColor}`,children:g.status})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-xs leading-tight mb-1",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Código:"}),e.jsx("span",{className:"ml-1 font-semibold text-gray-800",children:g.codigo})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("span",{className:"text-gray-600",children:"Cidade:"}),e.jsx("span",{className:"ml-1 font-semibold text-gray-800",children:g.cidade})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-xs leading-tight mb-3",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-red-600",children:"Valor Total:"}),e.jsx("span",{className:"ml-1 font-semibold text-red-700",children:g.valorTotal})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("span",{className:"text-gray-600",children:"Rota:"}),e.jsx("span",{className:"ml-1 font-semibold text-gray-800",children:g.rota})]})]}),e.jsxs("div",{className:"border-t border-gray-100 pt-2 mb-3",children:[e.jsx("p",{className:"text-xs font-medium text-gray-700 mb-2",children:"Títulos Atrasados:"}),e.jsx("div",{className:"space-y-1",children:g.titulosAbertos.map((d,i)=>{const f=d.dias_atraso||0;return e.jsxs("div",{className:"grid grid-cols-3 gap-2 text-xs items-center",children:[e.jsx("span",{className:"text-gray-600",children:d.vencimento}),e.jsxs("span",{className:"text-center text-red-600 font-medium",children:[f,"d"]}),e.jsx("span",{className:"font-semibold text-red-600 text-right",children:P(d.valor)})]},i)})})]}),e.jsx("div",{className:"border-t border-gray-100 pt-3",children:e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("button",{onClick:()=>window.open(`tel:${g.telefone}`,"_self"),className:"w-full bg-primary text-white py-2 sm:py-2.5 rounded-lg font-medium hover:bg-primary/90 transition-colors flex items-center justify-center gap-2",children:[e.jsx(ve,{className:"h-4 w-4"}),e.jsx("span",{className:"text-xs sm:text-sm",children:"Ligar"})]}),e.jsxs("button",{onClick:()=>window.open(`https://wa.me/${g.telefone.replace(/\D/g,"")}`,"_blank"),className:"w-full bg-green-600 text-white py-2 sm:py-2.5 rounded-lg font-medium hover:bg-green-700 transition-colors flex items-center justify-center gap-2",children:[e.jsx(fe,{className:"h-4 w-4"}),e.jsx("span",{className:"text-xs sm:text-sm",children:"WhatsApp"})]})]})})]})},g.id)):e.jsxs("div",{className:"text-center py-12 text-gray-500",children:[e.jsx("p",{className:"text-lg mb-2",children:"Nenhum inadimplente encontrado"}),e.jsx("p",{className:"text-sm",children:t?"Tente ajustar o filtro de busca.":je(r)?"Não há clientes inadimplentes no sistema.":"Todos os seus clientes estão em dia!"})]})})]})]})},T=({children:s})=>{const{user:r,loading:a}=q();return a?e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"Carregando..."})]})}):r?e.jsx(e.Fragment,{children:s}):e.jsx(_e,{to:"/",replace:!0})},Xs=Ce([{path:"/",element:e.jsx(ws,{})},{path:"/dashboard",element:e.jsx(T,{children:e.jsx(A,{children:e.jsx(Is,{})})})},{path:"/rotas",element:e.jsx(T,{children:e.jsx(A,{children:e.jsx(Ts,{})})})},{path:"/rotas/:rotaId/cidades",element:e.jsx(T,{children:e.jsx(A,{children:e.jsx(Ls,{})})})},{path:"/rotas/:rotaId/cidades/:cidadeNome/clientes",element:e.jsx(T,{children:e.jsx(A,{children:e.jsx(Ds,{})})})},{path:"/rotas/:rotaId/cidades/:cidadeNome/clientes/:clienteId/detalhes",element:e.jsx(T,{children:e.jsx(A,{children:e.jsx(le,{})})})},{path:"/clientes/detalhes/:id",element:e.jsx(T,{children:e.jsx(A,{children:e.jsx(le,{})})})},{path:"/inadimplentes",element:e.jsx(T,{children:e.jsx(A,{children:e.jsx(Js,{})})})}]);function Zs(){return e.jsx(Fe,{children:e.jsx(Ee,{router:Xs})})}typeof window<"u"&&(window.supabase=j,console.log("🔗 Supabase client disponível globalmente como window.supabase"));De.createRoot(document.getElementById("root")).render(e.jsx(ke.StrictMode,{children:e.jsx(Zs,{})}));
